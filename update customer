USE bookstore;
DELIMITER //

CREATE PROCEDURE deleteInvalidCustomers()
BEGIN
    -- Create a temporary table to store IDs to be deleted
    CREATE TEMPORARY TABLE tempToDelete (idToDelete VARCHAR(10));

    -- Insert IDs with invalid phone numbers
    INSERT INTO tempToDelete
    SELECT id FROM customer WHERE LENGTH(phone) != 10 OR phone NOT REGEXP '^[0-9]+$';

    -- Insert IDs with invalid email addresses
    INSERT INTO tempToDelete
    SELECT id FROM customer WHERE email NOT REGEXP '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$';

    -- Insert IDs where referrer is the same as the customer ID
 INSERT INTO tempToDelete
    SELECT id FROM customer WHERE id = referrer;
INSERT INTO tempToDelete
    SELECT id FROM customer WHERE dob > CURDATE();
   
INSERT INTO tempToDelete
    SELECT id FROM customer WHERE point < 0;
  

    -- Delete rows from customer table based on the temporary table
    DELETE FROM customer WHERE id IN (SELECT idToDelete FROM tempToDelete);

    -- Drop the temporary table
    DROP TEMPORARY TABLE IF EXISTS tempToDelete;
END;
//

DELIMITER ;

